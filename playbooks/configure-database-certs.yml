---
# Configure Vault Agent with PostgreSQL certificate templates
# Run this AFTER setup-database-server.yml
- name: Configure Vault Agent for PostgreSQL TLS Certificates
  hosts: db_server
  become: true
  gather_facts: true
  
  vars:
    vault_addr: "{{ vault_server_address | default('https://vault.hashicorp.local:8200') }}"
    domain: "{{ target_domain | default('hashicorp.local') }}"
    
  tasks:
    - name: Check if Vault Agent config needs repair (from previous failed run)
      ansible.builtin.shell: |
        # Count opening and closing braces
        OPEN=$(grep -o '{' /etc/vault.d/vault-agent-config.hcl | wc -l)
        CLOSE=$(grep -o '}' /etc/vault.d/vault-agent-config.hcl | wc -l)
        if [ "$OPEN" -ne "$CLOSE" ]; then
          echo "CORRUPT"
        else
          echo "OK"
        fi
      register: config_check
      changed_when: false
      
    - name: Remove corrupted PostgreSQL templates block if present
      ansible.builtin.blockinfile:
        path: /etc/vault.d/vault-agent-config.hcl
        marker: "# {mark} ANSIBLE MANAGED - PostgreSQL Certificate Templates"
        state: absent
      when: config_check.stdout == "CORRUPT"
      
    - name: Restore missing closing brace for CA template if needed
      ansible.builtin.lineinfile:
        path: /etc/vault.d/vault-agent-config.hcl
        regexp: '^  error_on_missing_key = true$'
        line: "  error_on_missing_key = true\n}"
        backrefs: yes
      when: config_check.stdout == "CORRUPT"
      
    - name: Create PostgreSQL certificate renewal template
      ansible.builtin.copy:
        content: |
          {% raw %}{{- /* PostgreSQL Server Certificate Template */ -}}
          {{ with secret "pki/issue/server" "common_name={% endraw %}{{ inventory_hostname }}.{{ domain }}{% raw %}" "ttl=90s" "alt_names={% endraw %}{{ inventory_hostname }}{% raw %},localhost" }}
          {{ .Data.certificate }}
          {{ end }}{% endraw %}
        dest: /etc/vault.d/templates/pgsql-cert-renewal.ctmpl
        mode: '0644'
        
    - name: Create PostgreSQL key renewal template
      ansible.builtin.copy:
        content: |
          {% raw %}{{- /* PostgreSQL Server Private Key Template */ -}}
          {{ with secret "pki/issue/server" "common_name={% endraw %}{{ inventory_hostname }}.{{ domain }}{% raw %}" "ttl=90s" "alt_names={% endraw %}{{ inventory_hostname }}{% raw %},localhost" }}
          {{ .Data.private_key }}
          {{ end }}{% endraw %}
        dest: /etc/vault.d/templates/pgsql-key-renewal.ctmpl
        mode: '0644'
        
    - name: Create PostgreSQL CA certificate template
      ansible.builtin.copy:
        content: |
          {% raw %}{{- /* PostgreSQL CA Certificate Chain Template */ -}}
          {{ with secret "pki/issue/server" "common_name={% endraw %}{{ inventory_hostname }}.{{ domain }}{% raw %}" "ttl=90s" }}
          {{ .Data.issuing_ca }}
          {{ end }}{% endraw %}
        dest: /etc/vault.d/templates/pgsql-ca-renewal.ctmpl
        mode: '0644'
        
    - name: Update Vault Agent configuration for PostgreSQL
      ansible.builtin.blockinfile:
        path: /etc/vault.d/vault-agent-config.hcl
        marker: "# {mark} ANSIBLE MANAGED - PostgreSQL Certificate Templates"
        insertafter: EOF
        block: |
          
          # PostgreSQL Server Certificate
          template {
            source      = "/etc/vault.d/templates/pgsql-cert-renewal.ctmpl"
            destination = "/etc/pgsql/certs/server.crt"
            perms       = "0644"
            user        = "postgres"
            group       = "postgres"
            command     = "/usr/bin/systemctl reload postgresql-15"
          }
          
          # PostgreSQL Server Private Key
          template {
            source      = "/etc/vault.d/templates/pgsql-key-renewal.ctmpl"
            destination = "/etc/pgsql/certs/server.key"
            perms       = "0600"
            user        = "postgres"
            group       = "postgres"
            command     = "/usr/bin/systemctl reload postgresql-15"
          }
          
          # PostgreSQL CA Certificate
          template {
            source      = "/etc/vault.d/templates/pgsql-ca-renewal.ctmpl"
            destination = "/etc/pgsql/certs/ca.crt"
            perms       = "0644"
            user        = "postgres"
            group       = "postgres"
            command     = "/usr/bin/systemctl reload postgresql-15"
          }
      notify: Restart Vault Agent
      
    - name: Flush handlers to restart Vault Agent immediately
      ansible.builtin.meta: flush_handlers
      
    - name: Wait for Vault Agent to be ready after restart
      ansible.builtin.wait_for:
        port: 8100
        delay: 2
        timeout: 30
      failed_when: false
      
    - name: Check Vault Agent status
      ansible.builtin.systemd:
        name: vault-agent
      register: vault_agent_status
      
    - name: Display Vault Agent status
      ansible.builtin.debug:
        msg: "Vault Agent is {{ vault_agent_status.status.ActiveState }}"
        
    - name: Check Vault Agent logs for errors
      ansible.builtin.command: journalctl -u vault-agent -n 20 --no-pager
      register: vault_logs
      changed_when: false
      
    - name: Display recent Vault Agent logs
      ansible.builtin.debug:
        var: vault_logs.stdout_lines
      
    - name: Enable TLS in PostgreSQL configuration now that certificates will be available
      ansible.builtin.lineinfile:
        path: "/var/lib/pgsql/15/data/postgresql.conf"
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        state: present
      loop:
        - { regexp: '^#?ssl ', line: "ssl = on" }
        - { regexp: '^#?ssl_cert_file', line: "ssl_cert_file = '/etc/pgsql/certs/server.crt'" }
        - { regexp: '^#?ssl_key_file', line: "ssl_key_file = '/etc/pgsql/certs/server.key'" }
        - { regexp: '^#?ssl_ca_file', line: "ssl_ca_file = '/etc/pgsql/certs/ca.crt'" }
      
    - name: Update PostgreSQL authentication to require TLS
      ansible.builtin.blockinfile:
        path: "/var/lib/pgsql/15/data/pg_hba.conf"
        marker: "# {mark} ANSIBLE MANAGED - TLS Required"
        block: |
          # TYPE  DATABASE        USER            ADDRESS                 METHOD
          # Local connections
          local   all             all                                     peer
          # Remote TLS connections (REQUIRED)
          hostssl all             all             0.0.0.0/0               scram-sha-256
          hostssl all             all             ::/0                    scram-sha-256
          # Reject non-TLS connections
          hostnossl all           all             0.0.0.0/0               reject
          hostnossl all           all             ::/0                    reject
      
    - name: Wait for Vault Agent to provision initial certificates
      ansible.builtin.wait_for:
        path: /etc/pgsql/certs/server.crt
        timeout: 120
        delay: 5
        msg: "Timeout waiting for Vault Agent to provision PostgreSQL certificates. Check Vault Agent logs: journalctl -u vault-agent -n 50"
        
    - name: Reload PostgreSQL to enable TLS
      ansible.builtin.systemd:
        name: postgresql-15
        state: reloaded
      
    - name: Display configuration summary
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════
          PostgreSQL Vault Agent Configuration Complete
          ═══════════════════════════════════════════════
          Templates Added:
            • pgsql-cert-renewal.ctmpl → /etc/pgsql/certs/server.crt
            • pgsql-key-renewal.ctmpl  → /etc/pgsql/certs/server.key
            • pgsql-ca-renewal.ctmpl   → /etc/pgsql/certs/ca.crt
          
          Certificate Rotation: Every 90 seconds
          Action: systemctl reload postgresql-15
          
          Vault Agent will now:
          1. Request certificates from Vault PKI
          2. Write to PostgreSQL cert directory
          3. Reload PostgreSQL when certs change
          4. PostgreSQL will use new certs without downtime
          ═══════════════════════════════════════════════
  
  handlers:
    - name: Restart Vault Agent
      ansible.builtin.systemd:
        name: vault-agent
        state: restarted
