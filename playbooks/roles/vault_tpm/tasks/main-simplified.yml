# roles/vault_tpm/tasks/main-simplified.yml - Simplified version for demo
---
# Simplified mode: Software-based private key (NOT TPM-protected)
# This creates a standard OpenSSL private key stored on disk
# For hardware-backed keys, enable vTPM and use main-full-tpm.yml

- name: Install basic dependencies
  ansible.builtin.package:
    name:
      - openssl
      - unzip
      - curl
    state: present

# Create secure directory for keys
- name: Create secure key directory
  ansible.builtin.file:
    path: /etc/vault.d
    state: directory
    mode: "0755"
    owner: root
    group: root

# Force regeneration - remove old keys and CSR if requested
- name: Remove old keys for regeneration
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/vault.d/private-key.pem
    - /etc/vault.d/csr.pem
  when: vault_tpm_force_regenerate | default(false)

# Generate a software-based private key (NOT TPM-protected)
- name: Generate software-based private key using OpenSSL (NOT TPM-protected)
  ansible.builtin.command:
    cmd: openssl genrsa -out /etc/vault.d/private-key.pem 2048
  args:
    creates: "{{ '/etc/vault.d/private-key.pem' if not (vault_tpm_force_regenerate | default(false)) else omit }}"

- name: Set secure permissions on private key
  ansible.builtin.file:
    path: /etc/vault.d/private-key.pem
    mode: "0600"
    owner: root
    group: root

# Generate CSR using the software-based private key
- name: Generate CSR using software-based private key
  ansible.builtin.command:
    cmd: >-
      openssl req -new -key /etc/vault.d/private-key.pem
      -subj "/CN={{ inventory_hostname }}.{{ domain | default('hashicorp.local') }}"
      -out /etc/vault.d/csr.pem
  args:
    creates: "{{ '/etc/vault.d/csr.pem' if not (vault_tpm_force_regenerate | default(false)) else omit }}"

# Ensure CSR was created successfully
- name: Check if CSR exists
  ansible.builtin.stat:
    path: /etc/vault.d/csr.pem
  register: vault_tpm_csr_stat
  failed_when: not vault_tpm_csr_stat.stat.exists
  changed_when: false

# Read CSR content from remote host
- name: Read CSR content from remote host
  ansible.builtin.slurp:
    src: /etc/vault.d/csr.pem
  register: vault_tpm_remote_csr_data

# Validate CSR was read successfully
- name: Validate CSR was read successfully
  ansible.builtin.fail:
    msg: "Failed to read CSR file. Check file existence and permissions."
  when: vault_tpm_remote_csr_data.content is not defined or vault_tpm_remote_csr_data.content | length == 0

# Set facts for other roles to use
- name: Set remote CSR data and key metadata as facts
  ansible.builtin.set_fact:
    vault_tpm_remote_csr_data_fact: "{{ vault_tpm_remote_csr_data }}"
    vault_tpm_private_key_path: "/etc/vault.d/private-key.pem"
    vault_tpm_key_type: "software"

# Display success message with security notice
- name: Display key generation summary and security notice
  ansible.builtin.debug:
    msg:
      - "✅ Private key and CSR generated for {{ inventory_hostname }}.{{ domain | default('hashicorp.local') }}"
      - "⚠️  SECURITY NOTICE: Using simplified mode (software-based private key)"
      - "Key location: /etc/vault.d/private-key.pem"
      - "Protection: File permissions only (0600)"
      - "For hardware-backed keys, enable vTPM and set vault_tpm_use_simplified: false"
