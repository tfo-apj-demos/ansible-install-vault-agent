---
# This task file bridges the gap between TPM setup and TLS auth
# It assumes TPM has already generated a private key and CSR has been signed

- name: Wait for SSH connection to become available
  ansible.builtin.wait_for_connection:
    delay: 30
    timeout: 180
    sleep: 15
  register: connection_wait
  ignore_errors: true

- name: Check connection status
  debug:
    msg: "Host is reachable"
  when: connection_wait is succeeded

- name: Gather facts manually
  ansible.builtin.setup:
  when: connection_wait is succeeded

- block:
    # Ensure private key is in correct location with correct permissions
    # vault_tpm role creates it at /etc/vault.d/private-key.pem
    - name: Check if private key exists from vault_tpm role
      stat:
        path: "{{ hostvars[inventory_hostname].vault_tpm_private_key_path | default('/etc/vault.d/private-key.pem') }}"
      register: private_key_stat

    - name: Ensure private key has correct permissions
      file:
        path: "{{ hostvars[inventory_hostname].vault_tpm_private_key_path | default('/etc/vault.d/private-key.pem') }}"
        mode: "0600"
        owner: root
        group: root
      when: private_key_stat.stat.exists
    - name: Check if signed certificate exists from vault_sign role
      stat:
        path: "{{ cert_dir | default('/etc/ssl/private') }}/cert.pem"
      register: signed_cert_stat

    - name: Copy signed certificate to Vault Agent directory
      copy:
        src: "{{ cert_dir | default('/etc/ssl/private') }}/cert.pem" 
        dest: /etc/vault.d/cert.pem
        mode: "0644"
        remote_src: yes
      when: signed_cert_stat.stat.exists

    - name: Copy CA certificate to Vault Agent directory
      copy:
        src: "{{ cert_dir | default('/etc/ssl/private') }}/ca.pem"
        dest: /etc/vault.d/ca.pem
        mode: "0644"
        remote_src: yes
      when: signed_cert_stat.stat.exists

    # Create certificate renewal templates
    - name: Create templates directory
      file:
        path: /etc/vault.d/templates
        state: directory
        mode: "0755"

    - name: Deploy certificate renewal template
      template:
        src: "cert-renewal.ctmpl.j2"
        dest: "/etc/vault.d/templates/cert-renewal.ctmpl"
        mode: "0644"

    - name: Deploy application key renewal template
      template:
        src: "app-key-renewal.ctmpl.j2"
        dest: "/etc/vault.d/templates/app-key-renewal.ctmpl"
        mode: "0644"

    - name: Deploy private key renewal template (references TPM key)
      template:
        src: "key-renewal.ctmpl.j2"
        dest: "/etc/vault.d/templates/key-renewal.ctmpl"
        mode: "0644"

    - name: Deploy CA renewal template
      template:
        src: "ca-renewal.ctmpl.j2" 
        dest: "/etc/vault.d/templates/ca-renewal.ctmpl"
        mode: "0644"

    # Deploy TLS-based Vault Agent configuration
    - name: Deploy Vault Agent TLS configuration
      template:
        src: "vault-agent-tls-config.hcl.j2"
        dest: "{{ vault_agent_config_file }}"
        backup: yes

    - name: Reload systemd and restart Vault Agent service
      systemd:
        name: vault-agent
        daemon_reload: yes
        enabled: yes
        state: restarted

    - name: Display TLS authentication setup summary
      ansible.builtin.debug:
        msg:
          - "âœ… TLS authentication configured for Vault Agent"
          - "Certificate: /etc/vault.d/cert.pem"
          - "Private key: {{ hostvars[inventory_hostname].vault_tpm_private_key_path | default('/etc/vault.d/private-key.pem') }}"
          - "Key type: {{ (hostvars[inventory_hostname].vault_tpm_key_type | default('software')) | upper }}"
          - "Security: {{ 'Hardware-backed (TPM)' if (hostvars[inventory_hostname].vault_tpm_key_type | default('software')) == 'tpm' else 'File permissions only (0600)' }}"

  when: connection_wait is succeeded
  rescue:
    - name: Log TLS setup failure
      debug:
        msg: "TLS setup failed. This could be due to missing certificates, systemd issues, or connection problems. Check previous task errors for details."
