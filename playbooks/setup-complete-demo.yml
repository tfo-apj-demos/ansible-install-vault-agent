---
# Master orchestration playbook for complete demo setup
# Runs all components in the correct sequence
- name: Complete Demo Environment Setup
  hosts: localhost
  gather_facts: false
  
  tasks:
    - name: Display setup overview
      ansible.builtin.debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Complete Demo Environment Setup
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          This playbook will:
          
          Phase 1: Database Server Setup
            â€¢ Install PostgreSQL 15
            â€¢ Configure TLS
            â€¢ Create demo database and user
          
          Phase 2: Web Server Setup
            â€¢ Install Python Flask application
            â€¢ Configure connection pooling
            â€¢ Setup signal handling for SIGUSR1
          
          Phase 3: Certificate Configuration
            â€¢ Configure Vault Agent templates for PostgreSQL
            â€¢ Configure Vault Agent templates for application
            â€¢ Setup EDA integration (KV write-back)
          
          Phase 4: Service Activation
            â€¢ Start PostgreSQL with TLS
            â€¢ Start Flask application
            â€¢ Start certificate rotation
          
          Inventory Groups Required:
            â€¢ db_servers  - Database servers
            â€¢ web_servers - Web application servers
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Starting setup in 5 seconds...
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
    - name: Pause for review
      ansible.builtin.pause:
        seconds: 5

# Phase 1: Setup PostgreSQL Database Server
- name: Phase 1 - Setup Database Server
  ansible.builtin.import_playbook: setup-database-server.yml

# Phase 2: Setup Flask Web Application  
- name: Phase 2 - Setup Web Application Server
  ansible.builtin.import_playbook: setup-web-server.yml

# Phase 3: Configure Database Certificate Rotation
- name: Phase 3 - Configure Database Certificates
  ansible.builtin.import_playbook: configure-database-certs.yml

# Phase 4: Configure Application Certificate Rotation
- name: Phase 4 - Configure Application Certificates
  ansible.builtin.import_playbook: configure-web-certs.yml

# Final Summary
- name: Setup Complete - Display Summary
  hosts: localhost
  gather_facts: false
  
  tasks:
    - name: Display final summary
      ansible.builtin.debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ‰ DEMO ENVIRONMENT SETUP COMPLETE ğŸ‰
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Components Deployed:
            âœ… PostgreSQL 15 with TLS on db_servers
            âœ… Flask Demo Application on web_servers
            âœ… Vault Agent certificate templates
            âœ… EDA integration via KV write-back
          
          Certificate Rotation Active:
            â€¢ PostgreSQL server certificates: Every 90s
            â€¢ Application client certificates: Every 90s
            â€¢ Automatic PostgreSQL reload on rotation
            â€¢ Automatic connection pool reload on rotation
          
          Event-Driven Automation:
            â€¢ Certificate rotation â†’ KV write
            â€¢ EDA detects KV change
            â€¢ Triggers Demo Job Template
            â€¢ Application pool reloads automatically
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Next Steps:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          1. Test Application Endpoints:
             curl http://web-server-01:5000/health
             curl http://web-server-01:5000/info
             curl http://web-server-01:5000/db/test
          
          2. Monitor Certificate Rotation:
             # On database server
             watch -n 5 'openssl x509 -in /etc/pgsql/certs/server.crt -noout -dates'
             
             # On web server
             watch -n 5 'openssl x509 -in /opt/demo-app/certs/client.crt -noout -dates'
          
          3. Monitor EDA Events:
             # In AAP, watch rulebook activation logs
             # Should see events every 90 seconds
          
          4. Verify Automation:
             # Check Demo Job Template executions in AAP
             # Should trigger after each cert rotation
          
          5. Check Application Logs:
             # On web server
             tail -f /opt/demo-app/logs/app.log
             # Should see "Connection pool reinitialized" messages
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Architecture Overview:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Vault PKI (server role, 90s TTL)
                    â†“
          Vault Agent (templates + exec blocks)
                    â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â†“                   â†“
          PostgreSQL        Flask App
          (TLS certs)       (Client certs)
          (reload)          (SIGUSR1 â†’ pool reload)
                            (exec â†’ KV write)
                            â†“
                            Vault KV
                            â†“
                            EDA (WebSocket listener)
                            â†“
                            Demo Job Template (AAP)
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Your demo is ready! ğŸš€
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
