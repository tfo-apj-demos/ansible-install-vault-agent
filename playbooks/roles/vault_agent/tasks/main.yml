---
- name: Wait for SSH connection to become available
  ansible.builtin.wait_for_connection:
    delay: 30
    timeout: 180
    sleep: 15
  register: connection_wait
  ignore_errors: yes

- name: Check connection status
  debug:
    msg: "Host is reachable"
  when: connection_wait is succeeded

- name: Gather facts manually
  ansible.builtin.setup:
  when: connection_wait is succeeded

- block:
    # Install Vault binary (always needed)
    - name: Ensure dependencies are installed
      ansible.builtin.package:
        name: "{{ item }}"
        state: present
      loop:
        - curl
        - unzip
      when: vault_agent_install_binary | default(true)

    - name: Download Vault binary
      ansible.builtin.get_url:
        url: "https://releases.hashicorp.com/vault/{{ vault_version }}/vault_{{ vault_version }}_linux_amd64.zip"
        dest: "/tmp/vault_{{ vault_version }}.zip"
      when: vault_agent_install_binary | default(true)

    - name: Extract Vault binary
      ansible.builtin.unarchive:
        src: "/tmp/vault_{{ vault_version }}.zip"
        dest: "/usr/local/bin/"
        remote_src: true
      when: vault_agent_install_binary | default(true)

    - name: Ensure Vault binary is executable
      ansible.builtin.file:
        path: "{{ vault_bin_path }}"
        mode: "0755"
        state: file
      when: vault_agent_install_binary | default(true)

    - name: Create Vault Agent config directory
      ansible.builtin.file:
        path: "{{ vault_config_dir }}"
        state: directory
        mode: "0775"
        owner: root
        group: root

    # Deploy systemd service FIRST (before any config)
    - name: Deploy systemd service for Vault Agent
      ansible.builtin.template:
        src: "vault-agent.service.j2"
        dest: "{{ vault_service_file }}"

    # Reload systemd so the service is available
    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: true

    # Configure based on TLS or basic setup
    - name: Include TLS setup tasks
      ansible.builtin.include_tasks: tls_setup.yml
      when: vault_agent_setup_tls | default(false)

    - name: Deploy Vault Agent configuration (basic)
      ansible.builtin.template:
        src: "vault-agent-config.hcl.j2"
        dest: "{{ vault_agent_config_file }}"
      when: not (vault_agent_setup_tls | default(false))

    # Start service (only for non-TLS setup, TLS setup handles its own restart)
    - name: Enable and start Vault Agent service (basic mode)
      ansible.builtin.systemd:
        name: vault-agent
        enabled: true
        state: started
      when: not (vault_agent_setup_tls | default(false))
  when: connection_wait is succeeded
  rescue:
    - name: Log vault agent installation failure
      debug:
        msg: "Vault Agent installation/configuration failed. Check previous task errors for details."