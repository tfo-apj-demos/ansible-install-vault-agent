---
# Complete end-to-end Vault Agent setup with TPM and TLS authentication
- name: Generate TPM key and CSR
  hosts: all
  become: true
  gather_facts: false
  vars:
    # Control variables for the flow
    vault_tpm_simplified: "{{ vault_tpm_use_simplified | default(true) }}"  # Default to simplified approach
    vault_addr: "{{ vault_server_address | default('https://vault.hashicorp.local:8200') }}"
    domain: "{{ target_domain | default('hashicorp.local') }}"
  roles:
    # Step 1: Configure TPM and generate CSR
    - vault_tpm

- name: Sign CSR via Vault using Execution Environment
  hosts: localhost
  gather_facts: false
  vars:
    vault_addr: "{{ vault_server_address | default('https://vault.hashicorp.local:8200') }}"
    vault_pki_path: "{{ vault_pki_mount_path | default('pki') }}"
    vault_pki_role: "tls-auth"  # Hardcoded: Always use tls-auth for authentication certificates
    target_hostname: "{{ hostvars[groups['all'][0]]['inventory_hostname'] }}"
    remote_csr_data: "{{ hostvars[groups['all'][0]].vault_tpm_remote_csr_data_fact }}"
    domain: "{{ target_domain | default('hashicorp.local') }}"
    cert_dir: "/etc/ssl/private"
  roles:
    # Step 2: Sign CSR and get certificate from Vault
    - vault_sign

- name: Install and configure Vault Agent with TLS authentication
  hosts: all
  become: true
  gather_facts: false
  vars:
    # Tell vault_agent role to install AND configure TLS
    vault_agent_install_binary: true
    vault_agent_setup_tls: true
    vault_addr: "{{ vault_server_address | default('https://vault.hashicorp.local:8200') }}"
    domain: "{{ target_domain | default('hashicorp.local') }}"
    # PKI variables for certificate renewal templates
    vault_pki_path: "{{ vault_pki_mount_path | default('pki') }}"
    vault_pki_role: "server"  # Hardcoded: Always use server role for application certificates
    cert_dir: "/etc/ssl/private"
  roles:
    # Step 3: Install Vault Agent and configure with TLS (single run)
    - vault_agent
