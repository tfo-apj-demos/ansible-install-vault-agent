---
# This task file bridges the gap between TPM setup and TLS auth
# It assumes TPM has already generated a private key and CSR has been signed

- name: Wait for SSH connection to become available
  ansible.builtin.wait_for_connection:
    delay: 30
    timeout: 180
    sleep: 15
  register: connection_wait
  ignore_errors: true

- name: Check connection status
  debug:
    msg: "Host is reachable"
  when: connection_wait is succeeded

- name: Gather facts manually
  ansible.builtin.setup:
  when: connection_wait is succeeded

- block:
    # Copy the generated private key to Vault Agent directory
    # Copy private key from where vault_tpm role created it
    - name: Check if private key exists from vault_tpm role
      stat:
        path: "{{ hostvars[inventory_hostname].vault_tpm_private_key_path | default('/root/vault-keys/private-key.pem') }}"
      register: private_key_stat

    - name: Copy private key to Vault Agent directory
      copy:
        src: "{{ hostvars[inventory_hostname].vault_tpm_private_key_path | default('/root/vault-keys/private-key.pem') }}"
        dest: /etc/vault.d/tpm-private-key.pem
        mode: "0600"
        owner: root
        group: root
        remote_src: yes
      when: private_key_stat.stat.exists    # Copy the signed certificate from where vault_sign role placed it
    - name: Check if signed certificate exists from vault_sign role
      stat:
        path: "{{ cert_dir | default('/etc/ssl/private') }}/cert.pem"
      register: signed_cert_stat

    - name: Copy signed certificate to Vault Agent directory
      copy:
        src: "{{ cert_dir | default('/etc/ssl/private') }}/cert.pem" 
        dest: /etc/vault.d/cert.pem
        mode: "0644"
        remote_src: yes
      when: signed_cert_stat.stat.exists

    - name: Copy CA certificate to Vault Agent directory
      copy:
        src: "{{ cert_dir | default('/etc/ssl/private') }}/ca.pem"
        dest: /etc/vault.d/ca.pem
        mode: "0644"
        remote_src: yes
      when: signed_cert_stat.stat.exists

    # Create certificate renewal templates
    - name: Create templates directory
      file:
        path: /etc/vault.d/templates
        state: directory
        mode: "0755"

    - name: Deploy certificate renewal template
      template:
        src: "cert-renewal.ctmpl.j2"
        dest: "/etc/vault.d/templates/cert-renewal.ctmpl"
        mode: "0644"

    - name: Deploy application key renewal template
      template:
        src: "app-key-renewal.ctmpl.j2"
        dest: "/etc/vault.d/templates/app-key-renewal.ctmpl"
        mode: "0644"

    - name: Deploy private key renewal template (references TPM key)
      template:
        src: "key-renewal.ctmpl.j2"
        dest: "/etc/vault.d/templates/key-renewal.ctmpl"
        mode: "0644"

    - name: Deploy CA renewal template
      template:
        src: "ca-renewal.ctmpl.j2" 
        dest: "/etc/vault.d/templates/ca-renewal.ctmpl"
        mode: "0644"

    # Deploy TLS-based Vault Agent configuration
    - name: Deploy Vault Agent TLS configuration
      template:
        src: "vault-agent-tls-config.hcl.j2"
        dest: "{{ vault_agent_config_file }}"
        backup: yes

    - name: Reload systemd and restart Vault Agent service
      systemd:
        name: vault-agent
        daemon_reload: yes
        enabled: yes
        state: restarted

  when: connection_wait is succeeded
  rescue:
    - name: Log unreachable host
      debug:
        msg: "Host is unreachable after waiting. Skipping TLS setup."